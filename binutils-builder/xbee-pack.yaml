schema-version: 1.0

type: builder


const:
  srcDir: /usr/src
 
out:
  bin-utils: /opt/bin-utils

dependencies:
  - origin: expect
  - origin: zlib

provision:
  - url:
      from: https://ftp.gnu.org/gnu/binutils/binutils-{% version %}.tar.xz
      todir: "{% srcDir %}"
  - url:
      from: https://www.linuxfromscratch.org/patches/lfs/11.0/binutils-{% version %}-upstream_fix-1.patch
      todir: "{% srcDir %}"
      unpack: false
  - folder: "{% srcDir %}/binutils-{% version %}/build"


build:
  - shell:
      cmds:
        - patch -Np1 -i ../binutils-{% version %}-upstream_fix-1.patch
        - sed -i '63d' etc/texi2pod.pl
        - find -name \*.1 -delete
      directory: "{% srcDir %}/binutils-{% version %}"
  - shell:
      cmds:
        - ../configure --prefix={% exportDir %} --enable-gold --enable-ld=default --enable-plugins --disable-werror --enable-64-bit-bfd --with-system-zlib
        - make tooldir={% exportDir %}
#        - make -k check (currently failing)
        - make tooldir={% exportDir %} install -j1
        - rm -fv {% exportDir %}/lib/lib{bfd,ctf,ctf-nobfd,opcodes}.a
      directory: "{% srcDir %}/binutils-{% version %}/build"
  - export: "{% exportDir %}"

